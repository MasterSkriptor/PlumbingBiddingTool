@page "/jobs/details/{JobId:int}"
@using PlumbingBiddingTool.Application.Jobs
@using PlumbingBiddingTool.Application.Contractors
@using PlumbingBiddingTool.Domain.Entities
@inject JobService JobService
@inject ContractorService ContractorService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer   

<PageTitle>Estimate - @job?.JobName</PageTitle>

@if (isLoading)
{
    <div class="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-2 text-light">Loading job details...</div>
    </div>
}

@if (job == null)
{
    <p><em>Job not found.</em></p>
}
else
{
    <!-- Action Buttons - Screen Only -->
    <div class="no-print mb-3">
        <button class="btn btn-success" @onclick="PrintEstimate">
            <i class="bi bi-printer"></i> Print Estimate
        </button>
        <button class="btn btn-primary" @onclick="() => EditJob()">Edit Job</button>
        <button class="btn btn-secondary" @onclick="() => BackToJobs()">Back to Jobs</button>
    </div>

    <!-- Estimate Container -->
    <div class="estimate-container">
        <!-- Letterhead -->
        <div class="estimate-header">
            <div class="row">
                <div class="col-8">
                    <h1 class="estimate-title">PLUMBING ESTIMATE</h1>
                    <div class="company-info">
                        <strong>@DisplayOrPlaceholder(companyInfo.Name, "Your Company Name")</strong><br />
                        @DisplayOrPlaceholder(companyInfo.Address, "123 Business Street")<br />
                        @DisplayOrPlaceholder(companyInfo.CityStateZip, "City, State 12345")<br />
                        Phone: @DisplayOrPlaceholder(companyInfo.Phone, "(555) 123-4567")<br />
                        Email: @DisplayOrPlaceholder(companyInfo.Email, "info@company.com")
                    </div>
                </div>
                <div class="col-4 text-end">
                    <div class="estimate-number">
                        <strong>Estimate #:</strong> @JobId.ToString("D6")<br />
                        <strong>Date:</strong> @DateTime.Now.ToString("MM/dd/yyyy")<br />
                        <strong>Status:</strong> <span class="status-badge status-@job.Status.ToString().ToLower()">@job.Status</span>
                    </div>
                </div>
            </div>
        </div>

        <hr class="estimate-divider" />

        <!-- Customer Information -->
        <div class="customer-section">
            <h5>PREPARED FOR:</h5>
            <div class="customer-info">
                <div><strong>Contractor:</strong> @job.Contractor.Name</div>
                <div><strong>Project:</strong> @job.JobName</div>
            </div>
        </div>

        <!-- Fixture Items Section -->
        @if (job.JobFixtureItems.Count > 0)
        {
            <div class="estimate-section">
                <h5 class="section-title">FIXTURE ITEMS</h5>
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-center" style="width: 80px;">Qty</th>
                            <th class="text-end" style="width: 120px;">Unit Price</th>
                            <th class="text-end" style="width: 120px;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in job.JobFixtureItems)
                        {
                            <tr>
                                <td>@item.FixtureItem?.Name</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">$@item.Price.ToString("N2")</td>
                                <td class="text-end">$@((item.Price * item.Quantity).ToString("N2"))</td>
                            </tr>
                        }
                        <tr class="subtotal-row">
                            <td colspan="3" class="text-end"><strong>Fixture Items Subtotal:</strong></td>
                            <td class="text-end"><strong>$@(job.JobFixtureItems.Sum(jfi => jfi.Price * jfi.Quantity).ToString("N2"))</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        }

        <!-- Job Options Section -->
        @if (job.JobOptions.Count > 0)
        {
            <div class="estimate-section">
                <h5 class="section-title">OPTIONAL ITEMS</h5>
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th class="text-center" style="width: 80px;">Qty</th>
                            <th class="text-end" style="width: 120px;">Unit Price</th>
                            <th class="text-end" style="width: 120px;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var option in job.JobOptions)
                        {
                            <tr>
                                <td>@option.Name</td>
                                <td class="text-center">@option.Quantity</td>
                                <td class="text-end">$@option.Price.ToString("N2")</td>
                                <td class="text-end">$@((option.Price * option.Quantity).ToString("N2"))</td>
                            </tr>
                        }
                        <tr class="subtotal-row">
                            <td colspan="3" class="text-end"><strong>Optional Items Subtotal:</strong></td>
                            <td class="text-end"><strong>$@(job.JobOptions.Sum(jo => jo.Price * jo.Quantity).ToString("N2"))</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        }

        <!-- Bid Items by Phase -->
        @if (bidItemsSummary.Count > 0)
        {
            <div class="estimate-section">
                <h5 class="section-title">DETAILED BID ITEMS BY PHASE</h5>
                @foreach (var phaseGroup in bidItemsSummary.GroupBy(b => b.Phase).OrderBy(g => g.Key))
                {
                    <h6 class="phase-header">@GetPhaseDisplayName(phaseGroup.Key)</h6>
                    <table class="estimate-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th class="text-center" style="width: 80px;">Qty</th>
                                <th class="text-end" style="width: 120px;">Unit Price</th>
                                <th class="text-end" style="width: 120px;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in phaseGroup)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td class="text-center">@item.TotalQuantity</td>
                                    <td class="text-end">$@item.Price.ToString("N2")</td>
                                    <td class="text-end">$@((item.Price * item.TotalQuantity).ToString("N2"))</td>
                                </tr>
                            }
                            <tr class="subtotal-row">
                                <td colspan="3" class="text-end"><strong>@GetPhaseDisplayName(phaseGroup.Key) Subtotal:</strong></td>
                                <td class="text-end"><strong>$@phaseGroup.Sum(i => i.Price * i.TotalQuantity).ToString("N2")</strong></td>
                            </tr>
                        </tbody>
                    </table>
                }
            </div>
        }

        <!-- Grand Total -->
        <div class="estimate-total">
            <div class="row">
                <div class="col-8 text-end">
                    <h4>TOTAL ESTIMATE:</h4>
                </div>
                <div class="col-4 text-end">
                    <h4 class="total-amount">$@job.TotalCost.ToString("N2")</h4>
                </div>
            </div>
        </div>

        <!-- Terms and Conditions -->
        <div class="estimate-footer">
            <h6>TERMS & CONDITIONS</h6>
            <ul>
                <li>This estimate is valid for 30 days for approval from the date above.</li>
                <li>Once accepted, this estimate is valid for one year unless otherwise agreed upon beforehand.</li>
                <li>All work performed according to standard plumbing codes and regulations.</li>
                <li>Payment terms: Project will be billed in four separate invoices based on completion of each phase:</li>
                <ul>
                    <li>Underground phase completion</li>
                    <li>Stack Out phase completion</li>
                    <li>Trim phase completion</li>
                    <li>Sewer phase completion</li>
                </ul>
                <li>Any changes to scope may affect final pricing and require written approval.</li>
            </ul>
            <div class="signature-line">
                <div class="row mt-4">
                    <div class="col-6">
                        <div class="signature-box">
                            <div class="signature-line-border"></div>
                            <p class="signature-label">Contractor Signature</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="signature-box">
                            <div class="signature-line-border"></div>
                            <p class="signature-label">Date</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int JobId { get; set; }

    private Job? job;
    private List<BidItemSummary> bidItemsSummary = new();
    private bool isLoading = false;
    private CompanyInfo companyInfo = new();

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        job = await JobService.GetJobByIdAsync(JobId);
        
        if (job != null)
        {
            // Build bid items summary from all fixture items
            var bidItemsDict = new Dictionary<int, BidItemSummary>();
            
            foreach (var jobFixture in job.JobFixtureItems)
            {
                if (jobFixture.FixtureItem?.BidItems != null)
                {
                    foreach (var bidItem in jobFixture.FixtureItem.BidItems)
                    {
                        if (bidItemsDict.ContainsKey(bidItem.Id))
                        {
                            bidItemsDict[bidItem.Id].TotalQuantity += jobFixture.Quantity;
                        }
                        else
                        {
                            bidItemsDict[bidItem.Id] = new BidItemSummary
                            {
                                Name = bidItem.Name,
                                Price = bidItem.Price,
                                Phase = bidItem.Phase,
                                TotalQuantity = jobFixture.Quantity
                            };
                        }
                    }
                }
            }
            
            bidItemsSummary = bidItemsDict.Values.ToList();
        }
        
        isLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "companyInfo");
            if (!string.IsNullOrWhiteSpace(json))
            {
                var loaded = System.Text.Json.JsonSerializer.Deserialize<CompanyInfo>(json);
                if (loaded != null)
                {
                    companyInfo = loaded;
                    StateHasChanged();
                }
            }
        }
    }

    private string GetStatusBadgeClass(JobStatus status)
    {
        return status switch
        {
            JobStatus.Open => "bg-primary",
            JobStatus.Accepted => "bg-success",
            JobStatus.Closed => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetPhaseDisplayName(Phase phase)
    {
        return phase switch
        {
            Phase.Underground => "Underground",
            Phase.StackOut => "Stack Out",
            Phase.Trim => "Trim",
            _ => phase.ToString()
        };
    }

    public void EditJob()
    {
        NavigationManager.NavigateTo($"/jobs/edit/{JobId}");
    }

    public void BackToJobs()
    {
        NavigationManager.NavigateTo("/jobs");
    }

    private async Task PrintEstimate()
    {
        await JSRuntime.InvokeVoidAsync("window.print");
    }

    private string DisplayOrPlaceholder(string value, string placeholder)
    {
        return string.IsNullOrWhiteSpace(value) ? placeholder : value;
    }

    private class CompanyInfo
    {
        public string Name { get; set; } = string.Empty;
        public string Address { get; set; } = string.Empty;
        public string CityStateZip { get; set; } = string.Empty;
        public string Phone { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
    }
    
    private class BidItemSummary
    {
        public string Name { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public Phase Phase { get; set; }
        public int TotalQuantity { get; set; }
    }
}
